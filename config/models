Account
    balance Milray

Payday
    date UTCTime


Transaction
    ts UTCTime

    credit AccountId Maybe
    debit AccountId Maybe

    payday PaydayId Maybe

    amount Milray

    reason Text
    info Text Maybe

User
    ident Text
    createdTs UTCTime Maybe
    hash Text Maybe
    salt Text Maybe
    name Text Maybe
    account AccountId
    avatar Text Maybe
    blurb Markdown Maybe
    statement Markdown Maybe
    ircNick Text Maybe
    readMessages UTCTime default=now()
    readApplications UTCTime default=now()
    readComments UTCTime default=now() -- The last time /newcomments was visited.
    readEdits UTCTime default=now()
    established Established default='EstUnestablished'
    UniqueUser ident
    UniqueUserAccount account
    deriving Typeable
    deriving Show

ViewTime
    user UserId
    project ProjectId
    type ViewType
    time UTCTime default=now()
    UniqueViewTimeUserProjectType user project type

UserSetting
    user UserId
    setting UserSettingName
    value String

Project
    createdTs UTCTime
    name Text
    handle Text
    description Markdown
    account AccountId
    shareValue Milray
    lastPayday PaydayId Maybe
    githubRepo Text Maybe
    UniqueProjectAccount account
    UniqueProjectHandle handle
    deriving Eq Show

ProjectBlog
    time UTCTime
    title Text
    user UserId
    project ProjectId
    discussion DiscussionId
    topContent Markdown
    bottomContent Markdown Maybe
    deriving Show

ProjectUserRole
    project ProjectId
    user UserId
    role Role
    UniqueProjectUserRole project user role
    deriving Show

ProjectUpdate
    updatedTs UTCTime
    project ProjectId
    author UserId
    description MarkdownDiff

ProjectLastUpdate
    project ProjectId
    update ProjectUpdateId
    UniqueProjectLastUpdate project

Pledge
    user UserId
    project ProjectId
    shares Int64
    fundedShares Int64
    UniquePledge user project

Invite
    createdTs UTCTime
    project ProjectId
    code Text
    user UserId
    role Role
    tag Text
    redeemed Bool
    redeemedTs UTCTime Maybe
    redeemedBy UserId Maybe
    UniqueInvite code

VolunteerApplication
    createdTs UTCTime
    project ProjectId
    user UserId
    name Text
    email Text
    otherContactInfo Text Maybe
    website Text Maybe
    location Text Maybe
    experience Textarea Maybe
    comments Textarea Maybe

Interest
    description Text

VolunteerInterest
    volunteer VolunteerApplicationId
    interest InterestId

Message
    project ProjectId Maybe
    createdTs UTCTime
    from UserId Maybe
    to UserId Maybe
    content Markdown
    -- Whether the message was sent automatically by Snowdrift, or by an actual user.
    automated Bool default=false

WikiPage
    target Text
    project ProjectId
    content Markdown
    discussion DiscussionId
    permissionLevel PermissionLevel
    UniqueWikiTarget project target

WikiEdit
    ts UTCTime
    user UserId
    page WikiPageId
    content Markdown
    comment Text Maybe

WikiLastEdit
    page WikiPageId
    edit WikiEditId
    UniqueWikiLastEdit page

Discussion
    nothing Int64

Comment
    createdTs UTCTime

    -- "Unestablished" users may still make comments, but they must be approved
    -- by a moderator. "Established" users' comments are marked as moderated by
    -- themselves (though this does not mean they are a moderator).
    moderatedTs UTCTime Maybe
    moderatedBy UserId Maybe

    discussion DiscussionId
    parent CommentId Maybe
    user UserId
    text Markdown
    depth Int

-- A comment has zero or more ancestors: its parent, grandparent, great
-- grandparent, etc.
CommentAncestor
    comment CommentId
    ancestor CommentId
    UniqueCommentAncestor comment ancestor
    deriving Show

-- A comment-being-closed event.
CommentClosure
    ts UTCTime
    closedBy UserId
    type ClosureType
    reason Markdown
    comment CommentId

-- A rethread event. Moderators may move comment threads around as they wish.
Rethread
    ts UTCTime            -- Timestamp.
    moderator UserId      -- The moderator that rethreaded.
    oldComment CommentId  -- The old comment that was rethreaded.
    reason Text           -- The reason for rethreading.

-- A flagging event, with one or more reason stored in CommentFlaggingReason.
CommentFlagging
    ts UTCTime
    flagger UserId
    comment CommentId

    -- These two fields are required to reconstruct the permalink to the comment,
    -- for inclusion in messages to the flagger/flaggee.
    projectHandle Text
    target Text

    message Markdown Maybe -- Optional message provided by the flagger.
    -- Only one flagging can exist for a comment at any given time.
    UniqueCommentFlagging comment

-- A reason associated with a comment flagging. One-to-many relation.
CommentFlaggingReason
    flagging CommentFlaggingId
    reason FlagReason
    UniqueCommentFlaggingReason flagging reason

-- An individual comment-rethread relation.
CommentRethread
    rethread RethreadId
    oldComment CommentId
    newComment CommentId

Tag
    name Text
    UniqueTag name

ProjectTag
    project ProjectId
    tag TagId
    UniqueProjectTag project tag

CommentTag
    comment CommentId
    tag TagId
    user UserId
    count Int default=1
    UniqueCommentTag comment tag user

-- A Comment can have at most one Ticket (i.e. the comment can be marked as a ticket)
Ticket
    createdTs UTCTime
    updatedTs UTCTime
    name Text
    comment CommentId
    UniqueTicket comment

Build
    bootTime UTCTime
    base Text
    diff Text

-- A User may be established by a number of different ways. Manual establishment
-- by a moderator is one of them.
ManualEstablishment
    establishedUser UserId
    establishingUser UserId
    UniqueManualEstablishment establishedUser

TagColor
    tag TagId
    user UserId
    color Int
    UniqueTagColor tag user
    deriving Typeable

DefaultTagColor
    tag TagId
    color Int
    UniqueDefaultTag tag

RoleEvent
    time UTCTime
    user UserId
    role Role
    project ProjectId
    added Bool

Doc
    name Text
    currentVersion WikiEditId
    UniqueDocName name

DocEvent
    time UTCTime
    doc DocId
    blessedVersion WikiEditId

DatabaseVersion
    lastMigration Int

PledgeFormRendered
    ts UTCTime
    order Text
    project ProjectId
    user UserId Maybe

SharesPledged
    ts UTCTime
    user UserId
    shares Int64
    render PledgeFormRenderedId

